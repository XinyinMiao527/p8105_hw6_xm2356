---
title: "Homework 6"
author: "Xinyin Miao (xm2356)"
date: "2025-11-22"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)   
library(broom)     
library(purrr)  
```

# Problem 1

```{r}
homicides <- readr::read_csv("data/homicide-data.csv") |>
  clean_names() |>
  mutate(
    city_state = str_c(city, ", ", state),
    solved = if_else(disposition == "Closed by arrest", 1L, 0L),
    victim_sex  = na_if(victim_sex,  "Unknown"),
    victim_race = na_if(victim_race, "Unknown"),
    victim_age = ifelse(victim_age %in% c("Unknown", ""), NA, victim_age),
    victim_age = as.numeric(victim_age)
    ) |>
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
         victim_race %in% c("White", "Black")
         ) |>
  mutate(
    victim_sex  = factor(victim_sex,  levels = c("Female", "Male")),
    victim_race = factor(victim_race, levels = c("White", "Black"))
  )

```

## For Baltimore,MD
```{r}
baltimore <-
  homicides |>
  filter(city_state == "Baltimore, MD")

baltimore_glm <-
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data   = baltimore,
    family = binomial()
  )

```

```{r}
baltimore_results <-
  baltimore_glm |>
  tidy(
    conf.int     = TRUE,
    exponentiate = TRUE 
  )

baltimore_male_female_or <-
  baltimore_results |>
  filter(term == "victim_sexMale") |>
  select(term, estimate, conf.low, conf.high)

baltimore_male_female_or |> 
  knitr::kable(digits = 4)

# the estimate and CI of the adjusted odds ratio for solving homicides comparing male to female victims keeping all other variables fixed

```

## For each of the cities
```{r}
city_results <-
  homicides |>
  nest(data = -city_state) |>
  mutate(
    model = map(data, \(df) glm( solved ~ victim_age + victim_sex + victim_race,  data   = df, family = binomial())
    ),
    tidied = map(model, \(m) tidy(m,
        conf.int     = TRUE,
        exponentiate = TRUE
      )
    )
  ) |>
  select(city_state, tidied) |>
  unnest(tidied) |>
  filter(term == "victim_sexMale") |> 
  select(city_state, estimate, conf.low, conf.high) |> 
  arrange(desc(estimate))

city_results |> 
  knitr::kable(digits = 4)

```

## Plot
```{r city-or-plot, fig.width=8, fig.height=7}
city_results_plot <-
  city_results |>
  mutate(
    city_state = forcats::fct_reorder(city_state, estimate)
  )

city_results_plot |>
  ggplot(aes(x = estimate, y = city_state)) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0) +
  geom_vline( xintercept = 1, linetype   = "dashed") +
  labs(
    x     = "Adjusted OR of solving homicide (male vs female victims)",
    y     = "City",
    title = "Adjusted odds ratios for male vs female victims by city"
  ) +
  theme_minimal()

```

The plot shows substantial variation across cities in the adjusted odds of solving homicides for male versus female victims. Although many cities have point estimates below 1—suggesting a tendency toward lower clearance odds for male victims—the confidence intervals for nearly all cities are wide and typically cross 1. Because this uncertainty is large, the apparent pattern is not statistically reliable, and we cannot confidently conclude that cases involving female victims are more likely to be solved.

# Problem 2

```{r}
library(p8105.datasets)
data("weather_df")
library(modelr)
```

## bootstrap fit
```{r}
set.seed(123)

boot_results <-
  weather_df |>
  drop_na(tmax, tmin, prcp) |>
  bootstrap(n = 5000) |>
  mutate(
    model  = map(strap, ~ lm(tmax ~ tmin + prcp, data = .x)),
    glance = map(model, broom::glance),
    tidy   = map(model, broom::tidy),
    
    r_sq = map_dbl(glance, "r.squared"),

    beta_tmin = map_dbl(tidy, ~ .x |>
                          filter(term == "tmin") |>
                          pull(estimate)),
    beta_prcp = map_dbl(tidy, ~ .x |>
                          filter(term == "prcp") |>
                          pull(estimate)),

    beta_ratio = beta_tmin / beta_prcp
  )

```

## the plot of r2
```{r}
boot_results |>
  ggplot(aes(x = r_sq)) +
  geom_histogram(bins = 30) +
  labs(
    x = expression(hat(r)^2),
    y = "Count",
    title = expression("Bootstrap distribution of " * hat(r)^2)
  ) +
  theme_bw()

```

## the plot of β1 / β2 
```{r}
boot_results |>
  ggplot(aes(x = beta_ratio)) +
  geom_histogram(bins = 30) +
  labs(
    x = expression(hat(beta)[1] / hat(beta)[2]),
    y = "Count",
    title = expression("Bootstrap distribution of " * hat(beta)[1] / hat(beta)[2])
  ) +
  theme_bw()
```

## the 2.5% and 97.5% quantiles
```{r}
boot_results |>
  summarize(
    r2_lower      = quantile(r_sq, 0.025),
    r2_upper      = quantile(r_sq, 0.975),
    ratio_lower   = quantile(beta_ratio, 0.025),
    ratio_upper   = quantile(beta_ratio, 0.975)
  )

```



















